# About Iterative Regression Tests

The iterative regression tests are a solution to reduce the current amount of regression tests for necb in openstudio standards.

Instead of testing the different building archetypes, there is one universal building geometry used for testing that contains a lot of geometry scenarios, including edge cases. This geometry can be found in "lib/openstudio-standards/standards/necb/NECB2011/data/geometry/EdgeCaseGeometry.osm".

To test the different space types in necb, there is a function that applies different sets of space types to the geometry (these are referred to as test sets). For each set of space types, a single regression tests is generated. Each necb release needs to have a test set generated. There are currently test sets generated for necb releases of 2011, 2015, 2017 and 2020.

# How to generate test sets for new NECB releases

The test sets are generated by a python file under test/necb/building_regression_tests/resources/spacetype_test_sets_generator.py, and only one test set is required per necb release.

To generate a test set for a new necb release, the python file needs to be updated. To do so, locate the dictionary named "NECBs" under the function parse_and_output_space_type_names(...). Then, add the path to the new necb space_types.json file with the appropriate key. Finally, under the main function, change the template string to the new template that has been added.

Note: The buffer size can be optimized when generating a test set for a new NECB release. To optimize, keep the buffer size between 5-10 and try to keep it as high as possible. On the other hand, the number of iterations should be as low as possible.

With these changes, the code will generate a test set for the new NECB release. The .json file should be under  space_types_data/NECB20xx-test-set-buffer-size-6.json. Note that a space_types_data/NECB20xx-space-type-names.json file will also be created. Both of these files are necessary for the tests to run.

Once a test-set is generated, it does not need to be generated again.

# How to update the helper methods for a new NECB release

Some helper functions found under test/necb/building_regression_tests/resources/regression_helper.rb need to be updated for a new necb release. Below is the information required to update these functions.

Two hashes have to be updated with new information regarding a new necb release. The hashes in question are spacetypes_paths and test_set_paths under the function apply_spacetype_iteration_to_model(...). Update both hashes with the path for the json names file and the json space type test sets file. These are the paths generated in the prior step, and should be very similar to the existing paths in the hashes.

# How to create the regression test files

Important note: The regression test files need to be tested, and thus this sectio needs to be updated. Read the additional notes below.

At this point, the new iterative regression tests can be created. There are two methods to creating these tests


# More details about the python generation file

It is not neccessary to know the details about the python algorithm to create new NECB iterative regression tests. Regardless, here are more details since the algorithm is not very obvious.

The algorithm first creates a list with all the space type name found in the space_types.json file in necb. Note however, that there are certain "equivalent" space types. They are the same space types but have a different schedule. This is obvious when looking at the naming file, but is important to the algorithm design.

To generate a test set, the list of all space types is shuffled. Then, the program inititate a loop.

For every iteration, the program will try to pop items from the shuffled list and add them to the current list until it's reached maximum capacity (arg: amount of spaces), at which point it will be added as a row to a 2D list. However, if an item popped is equivalent to another, it is not added to the current list. It is however added to a priority list, so that it is prioritised in future iterations. This will ensure that all the space types are added as soon as possible.

In every iteration but the first one, the first X items from the previous iteration's items list are kept. This X value is refered to the buffer sized, and can be visualised as a sliding window. This design choice is intended to help isolate problematic space types if there is a test failure.

The loop ends when every space type appears in at least one iteration, and the test set output is generated.

# Additional notes

Currently the eight EdgeCaseGeometry regression test files found under test\necb\building_regression_tests\tests produce inconsistent test results. The issue is likely linked to the dynamic methods in the test files (part that uses define_method).

Below are two methods that could solve this problem, but both need to be tested. 

First method: Using automatically generated files. These can be found under test\necb\building_regression_tests\iterative_tests. **These files need to be tested**. If there are syntax errors, take a look at test\necb\building_regression_tests\resources\generate_tests.py, and correct any syntax errors there, as this is the python script that generated the test files. Then, generate the test files again by running the script. This file could also be re-used to create tests for future necb releases.

To execute the python script and generate the test files, use the command
$ python generate_tests.py


TODO: Another potential fix for this is to add the setup() method in every dynamically created method. This is shown in the file test\necb\building_regression_tests\tests\test_necb_bldg_EdgeCaseGeometry_NECB2011_Electricity_potential_fix.rb. This fix has not been tested, so please try it, as it would reduce the amount of files needed for testing.
