# About Iterative Regression Tests

The iterative regression tests are a solution to reduce the current amount of regression tests for necb in openstudio standards.

Instead of testing the different building archetypes, there is one universal building geometry that contains various scenarios, including edge cases. This geometry can be found in "lib/openstudio-standards/standards/necb/NECB2011/data/geometry/EdgeCaseGeometry.osm".

To test different space types, the new regression test is an iterative test that dynamically creates multiple sub sets. Each of these subsets uses the same geometry but a different set of space types in it's spaces. These space type sets are consistent, and created once per

# How to generate test sets for new NECB releases

The test sets are generated by a python file under test/necb/building_regression_tests/resources/spacetype_test_sets_generator.py.

To generate a test set (should only be done for a new NECB release), the python file needs to be modified. First, locate the dictionary NECBs under the method parse_and_output_space_type_names(...), then add the path to the new necb space_types.json file with the appropriate key. Finally, under the main function, change the template string to the new template that's been added.

Note: The buffer size can be optimized when generating a test set for a new NECB release. To optimize, keep the buffer size between 5-10, but try to keep it as high as possible. Choose the buffer size that outputs the test set file with the larger amount of iterations.

With these changes, the code will generate a test set for the new NECB release. The .json file should be under  space_types_data/NECB20xx-test-set-buffer-size-6.json. Note that a space_types_data/NECB20xx-space-type-names.json file will also be added. This file is necessary for the test to run, and simply lists all the names of the space types in necb.

Once a test-set is generated, it does not need to be generated again.

# How to make an iterative test for a new NECB release

Before making the regression test ruby file, note that the any iterative test relies on helper functions found under test/necb/building_regression_tests/resources/regression_helper.rb. These functions need to be updated for any new NECB release.

The two changes that need to be made are changes to two hashes. The hashes in question are spacetypes_paths and test_set_paths under the function apply_spacetype_iteration_to_model(...). Update both hashes with the path for the json names file and the json space type test sets file generated in the prior step.

At this point, the new iterative regression tests can be created. These tests should be created under test/necb/building_regression_tests/tests. The naming scheme should be consisten with prior test files, thus the file should be named test_necb_bldg_EdgeCaseGeometry_NECB20xx_FuelType.rb. Note that there should be two files created, one for each fuel type.

The test file should be very similar to prevoius regression test files. The only changes to be done are the NECB template and the amount of iterations (change the .each loop range).

# More details about the python generation file

It is not neccessary to know the details about the python algorithm to create new NECB iterative regression tests. Regardless, here are more details since the algorithm is not very obvious.

The algorithm first creates a list with all the space type name found in the space_types.json file in necb. Note however, that there are certain "equivalent" space types. They are the same space types but have a different schedule. This is obvious when looking at the naming file, but is important to the algorithm design.

To generate a test set, the list of all space types is shuffled. Then, the program inititate a loop.

For every iteration, the program will try to pop items from the shuffled list and add them to the current list until it's reached maximum capacity (arg: amount of spaces), at which point it will be added as a row to a 2D list. However, if an item popped is equivalent to another, it is not added to the current list. It is however added to a priority list, so that it is prioritised in future iterations. This will ensure that all the space types are added as soon as possible.

In every iteration but the first one, the first X items from the previous iteration's items list are kept. This X value is refered to the buffer sized, and can be visualised as a sliding window. This design choice is intended to help isolate problematic space types if there is a test failure.

The loop ends when every space type appears in at least one iteration, and the test set output is generated.

# Additional notes

Currently the EdgeCaseGeometry regression test files produce inconsistent test results. The issue is likely linked to the dynamic methods in the test files, which look like define_method files.

TODO: A current fix is to use automatically generated files. These can be found under test\necb\building_regression_tests\iterative_tests. **They need to be tested**. If there are syntax errors, take a look at test\necb\building_regression_tests\resources\generate_tests.py, and correct the errors there, then the files again.

To execute the python script, use the command
$ python generate_tests.py


TODO: Another potential fix for this is to add the setup() method in every dynamically created method. This is shown in the file test\necb\building_regression_tests\tests\test_necb_bldg_EdgeCaseGeometry_NECB2011_Electricity_potential_fix.rb. This fix has not been tested, so please try it.
