# CircleCI Testing

CircleCi will test the files present in the [circlerci_tests.txt](/test/circleci_tests.txt) file. By default, the contents within the `circlerci_tests.txt` file is not complete. A script (`openstudio-standards/test/helpers/ci_test_generator.rb`) is used to automatically generate additional test files, as part of the steps executed by CircleCI. 

This script will generate the test files for NECB buildings, NECB HVAC systems, DOE 90.1 prm buildings, DOE Prototype buildings, and DOE HVAC systems. More tests can be added separately to the [`circlerci_tests.txt`](/test/circleci_tests.txt) file, or be auto-generated by the [`ci_test_generator.rb`](/test/helpers/ci_test_generator.rb) script. 

The main reason that the tests were split into smaller pieces and auto-generated was because CircleCI was not able to balance the workload accross multiple containers properly. Previously, there were some large tests (that could take about 30 minutes to run) and multiple smaller tests. Since there was two extremes with the timing of the tests, it caused inconsistent splitting of the tests. When these tests were not split evenly it caused some containers to run longer than others. There were consistant cases where one container would run 1 hour more than other containers. This caused long wait times and slowed down the development and testing process.

To resolve this load balancing issue, the larger tests that contain multiple sub-tests was split into multiple files. Each of the auto-generated files has unique file names, test names, and class names, such that the timing data could be reported individually and correctly.

For some of the tests, the timing reported was incorrect because bugs were present within the timing data written by the Minitest::CI. This caused issues with the CircleCI's load balancing algorithm for some of the containers. 

To resolve this issue, the tests were split using the timing data generated locally by running the full suite of tests run on CirlceCI locally. Then the timing data was then sorted in descending order, and each test was placed in the node that has the lowest load. 

The `ci_test_generator.rb` script contains a module that will auto-generate the test files, and split all the tests (both existing, and auto-generated) according to the pre-existing [timing data](/test/helpers/ci_test_helper/timings.json) (`openstudio-standards/test/helpers/ci_test_helper/timings.json`). 

__**NOTE**__: _The auto-generated test files are written to `openstudio-standards/test/ci_test_files` folder._

__**NOTE**__: _The number of splits is determined by reading the `parallelism` field in the CircleCI [config file](/.circleci/config.yml)._

__**NOTE**__: _If the timing for a new test file does not exist, a default timing of 240 seconds is assumed and stated as part of the console output._

__**NOTE**__: Whenever Rake is invoked (e.g. `bundle exec rake -T` or some other command using Rake):
  + It will invoke the following command: `CITestGenerator::generate(local_run: true, verbose: false)`
    + The CI test files would be generated into a file called `local_circleci_tests.txt`, 
    + The following folders would be deleted if it exists
        + `/output`
        + `/test/necb/output` and
        + `/test/ci_test_files`

To generate new timing data, see [`Local testing and generating local timing data`](#local-testing-and-generating-local-timing-data)topic below. Additionally, running the tests locally, it would also produce sample files of how the tests were split up for CircleCI.

## Local testing and generating local timing data
Whenever a new test is added, it is always good practice to generate a new [timing data file](/test/helpers/ci_test_helper/timings.json). The [timing data](/test/helpers/ci_test_helper/timings.json) is generated when the tests were run locally.

To produce just the files, run 
```bash
bundle exec rake test:gen-circ-files
```

Running this command will

1. Call the module `CITestGenerator::generate(local_run: false, verbose: true)` (invoked from Rakefile)
2. Delete the output folders if it exists (See __**NOTE**__ above)
3. generate the test files, 
4. Remove tests that were auto-generated from the __**`circleci_tests.txt`**__ file
5. writes all the newly generated test file locations whose file names begin with `test_necb` and `doe_test` to `circleci_tests.txt`
6. copies the required files for some specific tests (e.g. models used for necb and doe hvac tests)
7. splits the tests based on the timing data, and writes it to `openstudio-standards/test/helpers/ci_test_helper` folder in the format of `<container number>.txt` (e.g. `0.txt`, `1.txt`)

__**NOTE**__: _Running the command above will overwrite the `circleci_tests.txt` file_


________

To run **ALL** the tests, execute the following command
```bash
bundle exec rake test:local-circ-all-tests
```

Running this command will 

1. call the module `CITestGenerator::generate(local_run: true, verbose: true)` (invoked from from ci_test_generator.rb)
2. delete the output folders if it exists
3. generate the test files, 
4. Remove tests that were auto-generated from the `circleci_tests.txt` file
5. writes all the newly generated test file locations whose file names begin with `test_necb` and `doe_test` to __**`local_circleci_tests.txt`**__
6. copies the required files for some specific tests (e.g. models used for necb and doe hvac tests)
7. splits the tests based on the timing data, and writes it to `openstudio-standards/test/helpers/ci_test_helper` folder in the format of `<container number>.txt` (e.g. `0.txt`, `1.txt`)
8. __runs all the tests based on the number of processors specified in the `openstudio-standards/test/test_run_all_test_locally.rb` file__; and
9. __generates the `timings.json` file__

__**NOTE**__: _Running this command will not overwrite the `circleci_tests.txt` file, but it will create a file called `local_circleci_tests.txt` which is similar to the `circleci_tests.txt`_

__**NOTE**__:The container number of a CircleCI run is determined by using the built-in environment variable called `$CIRCLE_NODE_INDEX`. This is used as part of the `Parallelize Tests` step in the CircleCI's config.yml file.

To learn more about the built-in environment variables used in CircleCI visit [here](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)

## Regression testing and updating expected values

To run the NECB Building regression tests, execute the following command:
```bash
bundle exec rake test:necb_regression_test
```

__**The commands listed below will read the `local_circleci_tests.txt` (genereted whenever Rake is called e.g. `bundle exec rake -T`) files for the location of the test files, and filter them based on the command invoked from Rake**__

To run any tests that has 90_1_prm in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-90_1_prm`
```

To run any tests that has 90_1_general in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-90_1_general`
```

To run any tests that has doe in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-doe`
```

To run any tests that has doe_test_add_hvac_systems in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-doe_test_add_hvac_systems`
```

To run any tests that has doe_test_bldg in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-doe_test_bldg`
```

To run any tests that has necb in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-necb`
```

To run any tests that has necb_bldg in the file name/path, execute the following command:
```bash
`bundle exec rake test:local-circ-necb_bldg`
```

## Creating a new auto-generated test

This method is only valid to tests that use the same code with different variables.

1. First create the working test
2. Determine and group similar variables. 
    + In the example shown below, `templates` such as `NECB2011`, `NECB2015` are grouped together.
3. Create a method within the `CITestGenerator` module in `openstudio-standards/test/helpers/ci_test_generator.rb`.
4. Iterate through all combinations of the variable.
    + Copy the previously written test as a string, and use string substitution to generate a new string, which would be written to a file.
    + Make sure the files are written to the output directory by calling the `file_out_dir()` method.
    + NOTE: For now only test file names that begin with `test_necb` and `doe_test` are accepted. To change this behaviour modify the `write_file_path_to_ci_tests_txt` method.
5. After creating the method, add it to the `generate` method.
6. test that everything is working by running `bundle exec rake test:gen-circ-files`.

__**NOTE**__: _It is important to make each tests' method name and file name are unique **AND** consistent for each CircelCI run_

#### Sample code
```ruby
    templates = ['NECB2011', 'NECB2015'] # input variable 1
    building_types = [ # input variable 2
        "FullServiceRestaurant",
        "HighriseApartment",
        "Hospital",
        "LargeHotel",
        "LargeOffice",
        "MediumOffice",
        "MidriseApartment",
        "Outpatient",
        "PrimarySchool",
        "QuickServiceRestaurant",
        "RetailStandalone",
        "RetailStripmall",
        "SecondarySchool",
        "SmallHotel",
        "SmallOffice",
        "Warehouse"
    ]
    fuel_types = ['gas', 'electric'] # input variable 3
    
    out_dir = file_out_dir() # output directory
    # iterate all input variables
    templates.each {|template|
      building_types.each {|building_type|
        fuel_types.each {|fuel_type|
          # generate unique file name
          filename = File.join(out_dir,"test_necb_bldg_#{building_type}_#{template}_#{fuel_type}.rb")
          # this variable stores the content of the files
          file_string =%Q{
require_relative '../helpers/minitest_helper'
require_relative '../helpers/create_doe_prototype_helper'
require_relative '../helpers/compare_models_helper'
require_relative '../necb/regression_helper'

class Test_#{building_type}_#{template}_#{fuel_type} < NECBRegressionHelper
  def setup()
    super()
  end
  def test_#{template}_#{building_type}_regression_#{fuel_type}()

    result, msg = create_model_and_regression_test(building_type: '#{building_type}',
                                                   epw_file: @#{fuel_type}_location,
                                                   template: '#{template}'
    )
    assert(result, msg)
  end
end
}
          # write the file_string to a new file
          File.open(filename, 'w') { |file| file.write(file_string) }
        }
      }
    }
```
